<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        body {
            background-color: #1a1a1a;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background-color: #222;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 {
            margin: 0;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .admin-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.3;
            transition: all 0.3s;
        }
        .admin-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        .products-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            padding: 16px;
        }
        .product-card {
            background-color: #2a2a2a;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
            animation: fadeIn 0.5s ease-out forwards;
            opacity: 0;
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
        .product-image-container {
            position: relative;
            height: 200px;
            overflow: hidden;
        }
        .product-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
            cursor: pointer;
        }
        .product-image:hover {
            transform: scale(1.05);
        }
        .fullscreen-icon {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
        }
        .product-info {
            padding: 16px;
        }
        .product-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .product-price {
            color: #ffcc00;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .product-description {
            color: #aaa;
            font-size: 14px;
            margin-bottom: 16px;
            height: 60px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }
        .buy-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            width: 100%;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .buy-btn:hover {
            background-color: #3d8b40;
        }
        .admin-panel {
            display: none;
            justify-content: center;
            gap: 12px;
            padding: 16px;
            background-color: #222;
            position: sticky;
            top: 60px;
            z-index: 99;
        }
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .btn-secondary {
            background-color: #7f8c8d;
        }
        .btn-secondary:hover {
            background-color: #6c7a7b;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
        }
        .modal-content {
            background-color: #2a2a2a;
            margin: 5% auto;
            padding: 24px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            position: relative;
        }
        .close {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 28px;
            cursor: pointer;
        }
        input, textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            border: 1px solid #444;
            border-radius: 8px;
            background-color: #333;
            color: white;
            font-size: 16px;
            box-sizing: border-box;
        }
        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        .image-preview {
            margin-top: 16px;
            text-align: center;
        }
        .image-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
        }
        .admin-context-menu {
            position: absolute;
            top: 60px;
            right: 16px;
            background-color: #2a2a2a;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .context-menu-item {
            background: none;
            border: none;
            color: white;
            padding: 12px 24px;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }
        .context-menu-item:hover {
            background-color: #3498db;
        }
        .hidden {
            display: none;
        }
        .fullscreen-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .fullscreen-image {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }
        .fullscreen-close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 36px;
            color: white;
            background: none;
            border: none;
            cursor: pointer;
        }
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 3000;
            max-width: 300px;
        }
        .toast {
            padding: 16px;
            border-radius: 8px;
            color: white;
            opacity: 0;
            transform: translateY(20px);
            animation: toastIn 0.3s forwards;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .toast.removing {
            animation: toastOut 0.3s forwards;
        }
        .toast.info {
            background-color: #3498db;
        }
        .toast.success {
            background-color: #2ecc71;
        }
        .toast.error {
            background-color: #e74c3c;
        }
        .toast.warning {
            background-color: #f39c12;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }
        .refresh-panel {
            display: flex;
            justify-content: center;
            padding: 16px;
        }
        .product-detail-content {
            max-width: 600px;
        }
        .product-detail-header {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
        }
        .product-detail-image {
            width: 200px;
            height: 200px;
            object-fit: cover;
            border-radius: 12px;
            cursor: pointer;
        }
        .product-detail-info {
            flex: 1;
        }
        .product-detail-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 12px;
        }
        .product-detail-price {
            color: #ffcc00;
            font-size: 28px;
            font-weight: bold;
        }
        .product-detail-description {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 24px;
            color: #ddd;
        }
        .product-detail-actions {
            display: flex;
            gap: 12px;
        }
        .product-detail-buy-btn {
            flex: 1;
        }
        .header-loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            opacity: 0;
            transition: opacity 0.3s;
            margin-left: 10px;
        }
        .header-loading.visible {
            opacity: 1;
        }
        .skeleton-card {
            background-color: #2a2a2a;
            border-radius: 12px;
            overflow: hidden;
            animation: pulse 1.5s infinite;
            opacity: 0;
            animation: fadeIn 0.5s ease-out forwards;
        }
        .skeleton-image {
            height: 200px;
            background-color: #333;
        }
        .skeleton-content {
            padding: 16px;
        }
        .skeleton-title, .skeleton-price, .skeleton-description, .skeleton-button {
            background-color: #333;
            height: 20px;
            margin-bottom: 12px;
            border-radius: 4px;
        }
        .skeleton-title {
            width: 70%;
        }
        .skeleton-price {
            width: 40%;
        }
        .skeleton-description {
            width: 100%;
        }
        .skeleton-button {
            height: 40px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            vertical-align: middle;
            margin-right: 8px;
        }
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 0.3; }
        }
        @keyframes toastIn {
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes toastOut {
            to { opacity: 0; transform: translateY(20px); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
    </style>
</head>
<body>
    <div id="app">
        <header class="header">
            <h1>
                üéÆ PUBG Store
                <div id="header-loading" class="header-loading"></div>
            </h1>
            <button id="admin-btn" class="admin-btn" title="–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å" onclick="handleAdminClick()">‚öôÔ∏è</button>
        </header>
        
        <main class="main">
            <div id="products-container" class="products-container">
                <div class="empty-state">
                    <h2>–ú–∞–≥–∞–∑–∏–Ω –ø—É—Å—Ç</h2>
                    <p>–¢–æ–≤–∞—Ä—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º</p>
                </div>
            </div>
        </main>
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∞ -->
        <div id="admin-auth-modal" class="modal">
            <div class="modal-content">
                <span class="close">√ó</span>
                <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
                <input type="password" id="admin-password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                <button id="auth-submit" class="btn">–í–æ–π—Ç–∏</button>
            </div>
        </div>
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ -->
        <div id="add-product-modal" class="modal">
            <div class="modal-content">
                <span class="close">√ó</span>
                <h2>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h2>
                <form id="product-form">
                    <input type="text" id="product-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" required>
                    <input type="number" id="product-price" placeholder="–¶–µ–Ω–∞" step="0.01" required>
                    <textarea id="product-description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" rows="3"></textarea>
                    <input type="url" id="product-buy-link" placeholder="–°—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ (https://t.me/KOZLIK_pubg_shop_bot?start=c_123456)">
                    <input type="file" id="product-image" accept="image/*">
                    <div class="image-preview" id="image-preview"></div>
                    <div class="form-actions">
                        <button type="submit" class="btn">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
                        <button type="button" class="btn btn-secondary" id="cancel-add">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è -->
        <div id="change-password-modal" class="modal">
            <div class="modal-content">
                <span class="close">√ó</span>
                <h2>üîê –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h2>
                <div style="margin-bottom: 16px; font-size: 12px; color: #888;">
                    üí° –ü–∞—Ä–æ–ª—å –±—É–¥–µ—Ç –∏–∑–º–µ–Ω–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                </div>
                <form id="change-password-form">
                    <input type="password" id="current-password" placeholder="–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å" required>
                    <input type="password" id="new-password" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" required>
                    <input type="password" id="confirm-password" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" required>
                    <div class="form-actions">
                        <button type="submit" class="btn">üîÑ –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                        <button type="button" class="btn btn-secondary" id="cancel-password">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å -->
        <div id="admin-panel" class="admin-panel">
            <button id="add-product-btn" class="btn">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
            <button id="logout-btn" class="btn btn-secondary">–í—ã–π—Ç–∏</button>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div id="refresh-panel" class="refresh-panel">
            <button id="refresh-products-btn" class="btn btn-secondary">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –∞–¥–º–∏–Ω–∞ -->
        <div id="admin-context-menu" class="admin-context-menu hidden">
            <button id="change-password-btn" class="context-menu-item">
                <span>üîê</span> –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
            </button>
        </div>
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–æ–≤–∞—Ä–∞ -->
        <div id="product-detail-modal" class="modal">
            <div class="modal-content product-detail-content">
                <span class="close">√ó</span>
                <div id="product-detail-body">
                    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>
    
    <!-- Fullscreen Image Overlay -->
    <div id="fullscreen-overlay" class="fullscreen-overlay">
        <img id="fullscreen-image" class="fullscreen-image" src="" alt="">
        <button id="fullscreen-close" class="fullscreen-close">‚úï</button>
    </div>
    
    <script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
const tg = window.Telegram.WebApp;
// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
tg.ready();
tg.expand();
// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
let ADMIN_PASSWORD = localStorage.getItem('admin_password') || 'admin';
// –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
let isAdmin = false;
let products = [];
// –≠–ª–µ–º–µ–Ω—Ç—ã DOM (–±—É–¥—É—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM)
let productsContainer, adminBtn, adminAuthModal, addProductModal, adminPanel;
let adminPassword, authSubmit, addProductBtn, logoutBtn, productForm;
let imagePreview, productImage;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showToast(message, type = 'info', duration = 2000) {
    const toastContainer = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (—Å–Ω–∏–∑—É)
    toastContainer.insertBefore(toast, toastContainer.firstChild);
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ toast –¥–æ 3
    const toasts = toastContainer.querySelectorAll('.toast');
    if (toasts.length > 3) {
        const oldestToast = toasts[toasts.length - 1];
        oldestToast.classList.add('removing');
        setTimeout(() => {
            if (oldestToast.parentNode) {
                oldestToast.parentNode.removeChild(oldestToast);
            }
        }, 300);
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∑–∞–¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
    setTimeout(() => {
        if (toast.parentNode) {
            toast.classList.add('removing');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }
    }, duration);
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ –∫–ª–∏–∫—É
    toast.addEventListener('click', () => {
        if (toast.parentNode) {
            toast.classList.add('removing');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }
    });
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–ª–∏–∫–∞ –∞–¥–º–∏–Ω–∞
window.handleAdminClick = function() {
    const adminAuthModal = document.getElementById('admin-auth-modal');
    const adminContextMenu = document.getElementById('admin-context-menu');
    
    if (isAdmin) {
        // –ï—Å–ª–∏ –∞–¥–º–∏–Ω —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
        if (adminContextMenu) {
            adminContextMenu.classList.toggle('hidden');
        }
    } else {
        if (adminAuthModal) {
            adminAuthModal.style.display = 'block';
        }
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ —á–µ—Ä–µ–∑ Telegram Bot API
async function loadProducts() {
    console.log('üîÑ –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ç–æ–≤–∞—Ä–æ–≤ —á–µ—Ä–µ–∑ Telegram API...');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏
    showLoadingIndicators();
    showLoadingMessage('–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã...');
    
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –±–æ—Ç—É –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        const requestData = {
            action: 'get_products'
        };
        
        tg.sendData(JSON.stringify(requestData));
        showToast('üì° –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –±–æ—Ç—É...', 'info');
        
        // –û–∂–∏–¥–∞–µ–º –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ web_app_data —Å–æ–±—ã—Ç–∏–µ
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –∫–æ–Ω—Ü–µ –∫–æ–¥–∞
        
    } catch (error) {
        products = [];
        console.log('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
        showToast('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–æ–≤–∞—Ä–æ–≤', 'error');
        hideLoadingIndicators();
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞
function handleBotData(event) {
    try {
        const data = JSON.parse(event.data);
        console.log('üì¨ –î–∞–Ω–Ω—ã–µ –æ—Ç –±–æ—Ç–∞:', data);
        
        if (data.type === 'products') {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
            products = data.products || [];
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞
            if (data.adminPassword) {
                ADMIN_PASSWORD = data.adminPassword;
                localStorage.setItem('admin_password', ADMIN_PASSWORD);
                console.log('üîê –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞ –∑–∞–≥—Ä—É–∂–µ–Ω');
            }
            
            console.log('‚úÖ –¢–æ–≤–∞—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', products.length, '—à—Ç.');
            renderProducts();
            hideLoadingIndicators();
            showToast('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
            
        } else if (data.type === 'save_result') {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            if (data.success) {
                showToast('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
            } else {
                showToast(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
            }
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞:', error);
        showToast('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞', 'error');
        hideLoadingIndicators();
    }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ —á–µ—Ä–µ–∑ Telegram Bot API
async function saveProducts() {
    if (!isAdmin) {
        return;
    }
    
    try {
        const content = {
            products: products,
            adminPassword: ADMIN_PASSWORD, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ
            lastUpdated: new Date().toISOString()
        };
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É
        const requestData = {
            action: 'save_products',
            data: content
        };
        
        tg.sendData(JSON.stringify(requestData));
        showToast('üîÑ –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞...', 'info');
        
    } catch (error) {
        showToast('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
function renderProducts() {
    console.log('üé® –†–µ–Ω–¥–µ—Ä–∏–º —Ç–æ–≤–∞—Ä—ã, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:', products.length);
    
    if (products.length === 0) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –∏–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞
        const headerLoading = document.getElementById('header-loading');
        const isLoading = headerLoading && headerLoading.classList.contains('visible');
        
        if (!isLoading) {
            console.log('üì¶ –¢–æ–≤–∞—Ä–æ–≤ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ');
            productsContainer.innerHTML = `
                <div class="empty-state">
                    <h2>üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω –ø—É—Å—Ç</h2>
                    <p>–¢–æ–≤–∞—Ä—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º</p>
                </div>
            `;
        }
        return;
    }
    
    // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    console.log('üßπ –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–æ–≤–∞—Ä–æ–≤');
    if (!productsContainer) {
        console.error('‚ùå productsContainer –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
    }
    productsContainer.innerHTML = '';
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
    console.log('üé® –ù–∞—á–∏–Ω–∞–µ–º —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å —Ç–æ–≤–∞—Ä—ã...');
    products.forEach((product, index) => {
        const productCard = document.createElement('div');
        productCard.className = 'product-card';
        productCard.style.animationDelay = `${index * 0.1}s`;
        
        const imageHtml = product.image ? 
            `<div class="product-image-container">
                <img src="${product.image}" alt="${product.name}" class="product-image" onclick="event.stopPropagation(); openFullscreen('${product.image}', '${product.name}')">
                <button class="fullscreen-icon" onclick="event.stopPropagation(); openFullscreen('${product.image}', '${product.name}')" title="–û—Ç–∫—Ä—ã—Ç—å –≤ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ">üîç</button>
            </div>` : 
            '<div class="product-image"></div>';
        
        productCard.innerHTML = `
            ${imageHtml}
            <div class="product-info">
                <div class="product-name">${product.name}</div>
                <div class="product-price">${product.price} ‚ÇΩ</div>
                <div class="product-description">${product.description}</div>
                <button class="buy-btn" onclick="event.stopPropagation(); buyProduct(${product.id})">
                    <span>üõí –ö—É–ø–∏—Ç—å</span>
                </button>
                ${isAdmin ? `<button class="btn btn-secondary" style="margin-top: 8px; width: 100%; padding: 6px; font-size: 11px;" onclick="event.stopPropagation(); deleteProduct(${product.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>` : ''}
            </div>
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É (–Ω–æ –Ω–µ –Ω–∞ –∫–Ω–æ–ø–∫–∏ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
        productCard.addEventListener('click', (e) => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –Ω–µ –ø–æ –∫–Ω–æ–ø–∫–µ, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é –∏–ª–∏ –∏–∫–æ–Ω–∫–µ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
            if (!e.target.closest('.buy-btn') && 
                !e.target.closest('.btn-secondary') && 
                !e.target.closest('.product-image') && 
                !e.target.closest('.fullscreen-icon')) {
                showProductDetail(product.id);
            }
        });
        
        productsContainer.appendChild(productCard);
    });
    
    console.log('üéØ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω, —Ç–æ–≤–∞—Ä–æ–≤ –≤ DOM:', productsContainer.children.length);
}

// –ü–æ–∫—É–ø–∫–∞ —Ç–æ–≤–∞—Ä–∞
function buyProduct(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Å—ã–ª–∫—É –∏–∑ —Ç–æ–≤–∞—Ä–∞, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
    let botLink;
    if (product.buyLink && product.buyLink.trim()) {
        botLink = product.buyLink.trim();
    } else {
        // Fallback: —Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –±–æ—Ç–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–æ–≤–∞—Ä–µ
        const botParameter = `buy_${product.id}_${encodeURIComponent(product.name)}_${product.price}`;
        botLink = `https://t.me/KOZLIK_pubg_shop_bot?start=${botParameter}`;
    }
    
    try {
        // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞ —á–µ—Ä–µ–∑ Telegram API
        tg.openTelegramLink(botLink);
        showToast(`üõí –ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø–æ–∫—É–ø–∫–µ "${product.name}"...`, 'info', 1500);
    } catch (error) {
        console.log('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Å—Å—ã–ª–∫–∏:', error);
        // Fallback: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—ã—á–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        const purchaseData = {
            action: 'buy_product',
            product: {
                id: product.id,
                name: product.name,
                price: product.price,
                description: product.description,
                buyLink: product.buyLink
            },
            user_id: tg.initDataUnsafe?.user?.id,
            timestamp: Date.now()
        };
        
        tg.sendData(JSON.stringify(purchaseData));
        showToast(`üõí –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –±–æ—Ç—É`, 'success', 1000);
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º Mini App —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
        setTimeout(() => {
            tg.close();
        }, 1000);
    }
}

// –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)
async function deleteProduct(productId) {
    if (!isAdmin) return;
    
    const product = products.find(p => p.id === productId);
    const productName = product ? product.name : '—Ç–æ–≤–∞—Ä';
    
    products = products.filter(p => p.id !== productId);
    renderProducts(); // –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    await saveProducts();
    showToast(`üóëÔ∏è "${productName}" —É–¥–∞–ª–µ–Ω`, 'info');
}

// –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
function openModal(modal) {
    modal.style.display = 'block';
}

function closeModal(modal) {
    modal.style.display = 'none';
}

// –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
window.openFullscreen = function(imageSrc, altText) {
    const overlay = document.getElementById('fullscreen-overlay');
    const image = document.getElementById('fullscreen-image');
    
    image.src = imageSrc;
    image.alt = altText;
    overlay.style.display = 'flex';
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.body.style.overflow = 'hidden';
}

window.closeFullscreen = function() {
    const overlay = document.getElementById('fullscreen-overlay');
    overlay.style.display = 'none';
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.body.style.overflow = 'auto';
}

// –§—É–Ω–∫—Ü–∏—è —Å–∂–∞—Ç–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
function compressImage(file, maxWidth = 800, maxHeight = 600, quality = 0.8) {
    return new Promise((resolve, reject) => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        if (!file.type.startsWith('image/')) {
            reject(new Error('–§–∞–π–ª –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º'));
            return;
        }
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = () => {
            try {
                // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–π
                let { width, height } = img;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
                const scaleX = maxWidth / width;
                const scaleY = maxHeight / height;
                const scale = Math.min(scaleX, scaleY, 1); // –ù–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                
                const newWidth = Math.round(width * scale);
                const newHeight = Math.round(height * scale);
                
                canvas.width = newWidth;
                canvas.height = newHeight;
                
                // –£–ª—É—á—à–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                
                // –†–∏—Å—É–µ–º —Å–∂–∞—Ç–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                ctx.drawImage(img, 0, 0, newWidth, newHeight);
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞
                let outputFormat = 'image/jpeg';
                let outputQuality = quality;
                
                // –î–ª—è PNG —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω—è–µ–º PNG
                if (file.type === 'image/png') {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏
                    const imageData = ctx.getImageData(0, 0, newWidth, newHeight);
                    const hasTransparency = imageData.data.some((_, i) => i % 4 === 3 && imageData.data[i] < 255);
                    
                    if (hasTransparency) {
                        outputFormat = 'image/png';
                        outputQuality = undefined; // PNG –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç quality
                    }
                }
                
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64
                const compressedDataUrl = canvas.toDataURL(outputFormat, outputQuality);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                const originalSize = file.size;
                const compressedSize = Math.round((compressedDataUrl.length * 3) / 4); // –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä base64
                
                console.log(`üì∏ –°–∂–∞—Ç–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${Math.round(originalSize/1024)}KB ‚Üí ${Math.round(compressedSize/1024)}KB (${Math.round((1-compressedSize/originalSize)*100)}% —ç–∫–æ–Ω–æ–º–∏–∏)`);
                
                resolve({
                    dataUrl: compressedDataUrl,
                    originalSize,
                    compressedSize,
                    width: newWidth,
                    height: newHeight,
                    format: outputFormat
                });
                
            } catch (error) {
                reject(error);
            }
        };
        
        img.onerror = () => {
            reject(new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è'));
        };
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        img.src = URL.createObjectURL(file);
    });
}

// –§—É–Ω–∫—Ü–∏–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –∑–∞–≥—Ä—É–∑–∫–∏
function showLoadingIndicators() {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –≤ header
    const headerLoading = document.getElementById('header-loading');
    if (headerLoading) {
        headerLoading.classList.add('visible');
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–µ–ª–µ—Ç–æ–Ω-–∫–∞—Ä—Ç–æ—á–∫–∏
    showSkeletonCards();
}

function hideLoadingIndicators() {
    // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –≤ header
    const headerLoading = document.getElementById('header-loading');
    if (headerLoading) {
        headerLoading.classList.remove('visible');
    }
}

function showSkeletonCards(count = 6) {
    if (!productsContainer) return;
    
    productsContainer.className = 'loading-state';
    productsContainer.innerHTML = '';
    
    for (let i = 0; i < count; i++) {
        const skeletonCard = document.createElement('div');
        skeletonCard.className = 'skeleton-card';
        skeletonCard.style.animationDelay = `${i * 0.1}s`;
        
        skeletonCard.innerHTML = `
            <div class="skeleton-image"></div>
            <div class="skeleton-content">
                <div class="skeleton-title"></div>
                <div class="skeleton-price"></div>
                <div class="skeleton-description"></div>
                <div class="skeleton-description"></div>
                <div class="skeleton-button"></div>
            </div>
        `;
        
        productsContainer.appendChild(skeletonCard);
    }
}

function showLoadingMessage(message) {
    const headerLoading = document.getElementById('header-loading');
    if (headerLoading) {
        headerLoading.title = message;
    }
}

// –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Ç–æ–≤–∞—Ä–∞
function showProductDetail(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;
    
    const modal = document.getElementById('product-detail-modal');
    const body = document.getElementById('product-detail-body');
    
    const imageHtml = product.image ? 
        `<img src="${product.image}" alt="${product.name}" class="product-detail-image" onclick="openFullscreen('${product.image}', '${product.name}')">` : 
        '<div class="product-detail-image"></div>';
    
    body.innerHTML = `
        <div class="product-detail-header">
            ${imageHtml}
            <div class="product-detail-info">
                <div class="product-detail-name">${product.name}</div>
                <div class="product-detail-price">${product.price} ‚ÇΩ</div>
            </div>
        </div>
        <div class="product-detail-description">${product.description}</div>
        <div class="product-detail-actions">
            <button class="btn product-detail-buy-btn" onclick="buyProduct(${product.id}); closeProductDetail()">
                <span>üõí –ö—É–ø–∏—Ç—å</span>
            </button>
            ${isAdmin ? `<button class="btn btn-secondary" onclick="deleteProduct(${product.id}); closeProductDetail()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>` : ''}
        </div>
    `;
    
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeProductDetail() {
    const modal = document.getElementById('product-detail-modal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
document.addEventListener('DOMContentLoaded', () => {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    productsContainer = document.getElementById('products-container');
    console.log('üéØ productsContainer –Ω–∞–π–¥–µ–Ω:', !!productsContainer);
    adminBtn = document.getElementById('admin-btn');
    adminAuthModal = document.getElementById('admin-auth-modal');
    addProductModal = document.getElementById('add-product-modal');
    adminPanel = document.getElementById('admin-panel');
    adminPassword = document.getElementById('admin-password');
    authSubmit = document.getElementById('auth-submit');
    addProductBtn = document.getElementById('add-product-btn');
    logoutBtn = document.getElementById('logout-btn');
    productForm = document.getElementById('product-form');
    imagePreview = document.getElementById('image-preview');
    productImage = document.getElementById('product-image');
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è
    const changePasswordModal = document.getElementById('change-password-modal');
    const changePasswordForm = document.getElementById('change-password-form');
    const currentPasswordInput = document.getElementById('current-password');
    const newPasswordInput = document.getElementById('new-password');
    const confirmPasswordInput = document.getElementById('confirm-password');
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
    const adminContextMenu = document.getElementById('admin-context-menu');
    const changePasswordMenuBtn = document.getElementById('change-password-btn');
    
    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞
    tg.onEvent('web_app_data', handleBotData);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadProducts();
    
    // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω–∞
    if (adminBtn) {
        adminBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            if (isAdmin) {
                // –ê–¥–º–∏–Ω —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, –ø–∞–Ω–µ–ª—å –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞
            } else {
                openModal(adminAuthModal);
            }
        });
    }
    
    authSubmit.addEventListener('click', () => {
        if (adminPassword.value === ADMIN_PASSWORD) {
            isAdmin = true;
            adminBtn.style.opacity = '1';
            adminBtn.style.transform = 'scale(1.2)';
            setTimeout(() => {
                adminBtn.style.transform = 'scale(1)';
            }, 200);
            // –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞
            adminPanel.style.display = 'flex';
            closeModal(adminAuthModal);
            adminPassword.value = '';
            renderProducts();
            showToast('üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', 'success');
        } else {
            adminPassword.style.animation = 'shake 0.5s ease-in-out';
            setTimeout(() => {
                adminPassword.style.animation = '';
            }, 500);
            showToast('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!', 'error');
        }
    });
    
    logoutBtn.addEventListener('click', () => {
        isAdmin = false;
        adminBtn.style.opacity = '0.3';
        adminPanel.style.display = 'none';
        renderProducts();
        showToast('üëã –í—ã—Ö–æ–¥ –∏–∑ –∞–¥–º–∏–Ω–∫–∏', 'info');
    });
    
    addProductBtn.addEventListener('click', () => {
        openModal(addProductModal);
    });
    
    // –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ (–¥–æ—Å—Ç—É–ø–Ω–∞ –≤—Å–µ–º)
    const refreshProductsBtn = document.getElementById('refresh-products-btn');
    refreshProductsBtn.addEventListener('click', async () => {
        console.log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤...');
        await loadProducts();
        showToast('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
    });
    
    productImage.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                imagePreview.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;"><div class="loading"></div><br>–°–∂–∏–º–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...</div>';
                
                // –°–∂–∏–º–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                const compressed = await compressImage(file);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é —Å–∂–∞—Ç–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                imagePreview.innerHTML = `
                    <img src="${compressed.dataUrl}" alt="Preview">
                    <div style="margin-top: 8px; font-size: 11px; color: #888; text-align: center;">
                        üì∏ ${compressed.width}√ó${compressed.height} | ${Math.round(compressed.compressedSize/1024)}KB
                        ${compressed.originalSize !== compressed.compressedSize ? `(—ç–∫–æ–Ω–æ–º–∏—è ${Math.round((1-compressed.compressedSize/compressed.originalSize)*100)}%)` : ''}
                    </div>
                `;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∂–∞—Ç–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–µ
                e.target.compressedImage = compressed.dataUrl;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–∂–∞—Ç–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
                showToast('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
                imagePreview.innerHTML = '';
                e.target.value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ
            }
        } else {
            imagePreview.innerHTML = '';
            delete e.target.compressedImage;
        }
    });
    
    productForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const name = document.getElementById('product-name').value;
        const price = document.getElementById('product-price').value;
        const description = document.getElementById('product-description').value;
        const buyLink = document.getElementById('product-buy-link').value;
        const imageFile = productImage.files[0];
        const product = {
            id: Date.now(),
            name,
            price: parseFloat(price),
            description,
            buyLink: buyLink || null, // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –ø–æ–∫—É–ø–∫–∏
            image: null
        };
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="loading"></span> –î–æ–±–∞–≤–ª—è–µ–º...';
        submitBtn.disabled = true;
        
        if (imageFile && productImage.compressedImage) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∂–∞—Ç–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            product.image = productImage.compressedImage;
            products.push(product);
            saveProducts();
            
            // –ê–Ω–∏–º–∞—Ü–∏—è —É—Å–ø–µ—Ö–∞
            setTimeout(() => {
                renderProducts();
                closeModal(addProductModal);
                productForm.reset();
                imagePreview.innerHTML = '';
                delete productImage.compressedImage; // –û—á–∏—â–∞–µ–º —Å–∂–∞—Ç–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                showToast('‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
            }, 800);
        } else {
            setTimeout(() => {
                products.push(product);
                saveProducts();
                renderProducts();
                closeModal(addProductModal);
                productForm.reset();
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                showToast('‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
            }, 800);
        }
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
    document.querySelectorAll('.close').forEach(closeBtn => {
        closeBtn.addEventListener('click', (e) => {
            const modal = e.target.closest('.modal');
            if (modal.id === 'product-detail-modal') {
                closeProductDetail();
            } else {
                closeModal(modal);
            }
        });
    });
    
    document.getElementById('cancel-add').addEventListener('click', () => {
        closeModal(addProductModal);
        productForm.reset();
        imagePreview.innerHTML = '';
        delete productImage.compressedImage; // –û—á–∏—â–∞–µ–º —Å–∂–∞—Ç–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    });
    
    window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
            if (e.target.id === 'product-detail-modal') {
                closeProductDetail();
            } else {
                closeModal(e.target);
            }
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è
    changePasswordForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const currentPassword = currentPasswordInput.value;
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å
        if (currentPassword !== ADMIN_PASSWORD) {
            currentPasswordInput.style.animation = 'shake 0.5s ease-in-out';
            setTimeout(() => {
                currentPasswordInput.style.animation = '';
            }, 500);
            showToast('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å!', 'error');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è
        if (newPassword !== confirmPassword) {
            confirmPasswordInput.style.animation = 'shake 0.5s ease-in-out';
            setTimeout(() => {
                confirmPasswordInput.style.animation = '';
            }, 500);
            showToast('‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!', 'error');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è
        if (newPassword.length < 4) {
            newPasswordInput.style.animation = 'shake 0.5s ease-in-out';
            setTimeout(() => {
                newPasswordInput.style.animation = '';
            }, 500);
            showToast('‚ùå –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞!', 'error');
            return;
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –≥–ª–æ–±–∞–ª—å–Ω–æ
        ADMIN_PASSWORD = newPassword;
        localStorage.setItem('admin_password', newPassword);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞
        saveProducts().then(() => {
            showToast('‚úÖ –ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π!', 'success');
        }).catch(() => {
            showToast('‚ö†Ô∏è –ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å', 'warning');
        });
        
        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        changePasswordForm.reset();
        closeModal(changePasswordModal);
    });
    
    // –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è
    document.getElementById('cancel-password').addEventListener('click', () => {
        closeModal(changePasswordModal);
        changePasswordForm.reset();
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
    changePasswordMenuBtn.addEventListener('click', () => {
        adminContextMenu.classList.add('hidden');
        openModal(changePasswordModal);
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.addEventListener('click', (e) => {
        if (adminContextMenu && !adminContextMenu.contains(e.target) && 
            adminBtn && !adminBtn.contains(e.target)) {
            adminContextMenu.classList.add('hidden');
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    const fullscreenOverlay = document.getElementById('fullscreen-overlay');
    const fullscreenClose = document.getElementById('fullscreen-close');
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–Ω–æ–ø–∫–µ
    fullscreenClose.addEventListener('click', closeFullscreen);
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
    fullscreenOverlay.addEventListener('click', (e) => {
        if (e.target === fullscreenOverlay) {
            closeFullscreen();
        }
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∞–≤–∏—à–µ Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && fullscreenOverlay.style.display === 'flex') {
            closeFullscreen();
        }
    });
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
window.addEventListener('error', (event) => {
    showToast('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏', 'error', 3000);
});
    </script>
</body>
</html>